<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com; font-src 'self' https://cdnjs.cloudflare.com; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net;">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database Viewer</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Base Variables and Reset for VS Code Integration */
        :root {
            /* Professional Blue Color Palette */
            --primary-color: #0078d4;
            --primary-dark: #005a9e;
            --primary-light: #50a0e0;
            --secondary-color: #0078d4;
            --success-color: #107c10;
            --warning-color: #ff8c00;
            --danger-color: #d13438;
            --info-color: #0078d4;
            
            /* VS Code Integration */
            --light: var(--vscode-editor-background);
            --dark: var(--vscode-foreground);
            --gray: var(--vscode-descriptionForeground);
            --border-color: var(--vscode-panel-border);
            --sidebar-bg: var(--vscode-sideBar-background);
            
            /* Table Colors */
            --table-header-bg: #0078d4;
            --table-row-hover: rgba(0, 120, 212, 0.08);
            --table-row-even: rgba(0, 120, 212, 0.02);
            
            /* Spacing & Effects */
            --sidebar-padding: 15px;
            --item-spacing: 4px;
            --border-radius: 8px;
            --border-radius-sm: 6px;
            --transition: all 0.2s ease;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        
        @keyframes shimmer {
            0% { background-position: -1000px 0; }
            100% { background-position: 1000px 0; }
        }
        
        @keyframes bounceIn {
            from { transform: scale(0.95); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        @keyframes slideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(20px); opacity: 0; }
        }

        @keyframes slideInRight {
            from { transform: translateX(50px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideOutRight {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(50px); opacity: 0; }
        }

        /* Edit Mode Styles */
        .cell-edit-input {
            width: 100%;
            height: 100%;
            min-height: 24px;
            border: 2px solid var(--primary-color);
            outline: none;
            padding: 4px;
            font-family: inherit;
            font-size: inherit;
            background: var(--vscode-input-background);
            color: var(--vscode-input-foreground);
            box-sizing: border-box;
            display: block;
        }

        td.editing {
            padding: 0 !important;
        }

        td.editing::after {
            display: none !important;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--vscode-scrollbarSlider-background);
            border-radius: 10px;
            border: 2px solid var(--vscode-editor-background); 
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--vscode-scrollbarSlider-hoverBackground);
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-corner {
            background: transparent;
        }

        /* Notification Styles */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            color: white;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
            z-index: 10000;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            font-weight: 500;
            backdrop-filter: blur(4px);
        }

        .notification-success { background: var(--success-color); }
        .notification-error { background: var(--danger-color); }
        .notification-warning { background: var(--warning-color); }
        .notification-info { background: var(--info-color); }

        .notification.show {
            animation: slideInRight 0.35s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
        }

        .notification.hide {
            animation: slideOutRight 0.3s ease-in forwards;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        html, body {
            height: 100vh;
            width: 100vw;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        body {
            font-family: var(--vscode-font-family);
            background: var(--vscode-editor-background);
            color: var(--dark);
            display: flex;
            flex-direction: column;
        }

        .layout {
            display: flex;
            gap: 20px;
            width: 100%;
            height: 100%;
            padding: 15px;
            box-sizing: border-box;
            flex: 1;
            overflow: hidden;
            min-height: 0;
        }
        
        /* --- Sidebar (Table Selector) --- */
        .sidebar {
            width: 260px; 
            padding: var(--sidebar-padding) 0; 
            background: var(--sidebar-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            flex-shrink: 0;
            overflow-y: auto;
            max-height: calc(100vh - 30px);
            animation: slideIn 0.3s ease-out;
        }
        
        .search-box {
            padding: 0 var(--sidebar-padding);
            margin-bottom: 12px;
        }
        
        .search-box input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            background: var(--light);
            color: var(--dark);
            font-size: 13px;
            transition: var(--transition);
        }
        
        .search-box input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.1);
        }
        
        .sidebar-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 0 var(--sidebar-padding) 10px var(--sidebar-padding); 
            margin-bottom: 10px; 
            border-bottom: 1px solid var(--border-color);
        }
        
        .sidebar-header i {
            font-size: 16px;
            color: var(--primary-color);
        }
        
        .sidebar h3 {
            margin: 0;
            font-size: 14px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .sidebar ul {
            list-style: none;
            padding: 0; 
            /* Adjusted margin to bring list closer to header */
            margin: 5px 0 0 0; 
        }
        
        .sidebar ul li {
            /* KEY FIX: Removed all vertical margin on the LI element */
            margin-bottom: 0; 
            border-radius: 0; 
            overflow: visible; 
        }
        
        .table-item-link {
            display: flex;
            align-items: center;
            justify-content: space-between;
            text-decoration: none;
            color: var(--dark);
            font-size: 13px;
            padding: 10px 12px;
            transition: var(--transition);
            cursor: pointer;
            border-radius: 6px; 
            margin: var(--item-spacing) var(--sidebar-padding) 0 var(--sidebar-padding);
        }
        
        .table-item-content {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 1;
            min-width: 0;
        }
        
        .table-item-link i.table-icon {
            width: 18px;
            text-align: center;
            color: var(--gray);
            font-size: 14px;
        }
        
        .table-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .row-count-badge {
            background: var(--vscode-badge-background);
            color: var(--vscode-badge-foreground);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 11px;
            font-weight: 600;
            min-width: 24px;
            text-align: center;
        }
        
        .table-item-link:hover {
            background: var(--vscode-list-hoverBackground);
            color: var(--dark);
            transform: translateX(3px);
        }
        
        .table-item-link.active {
            background: var(--vscode-list-activeSelectionBackground);
            color: var(--vscode-list-activeSelectionForeground);
            font-weight: 600;
            transform: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .table-item-link.active i.table-icon {
            color: var(--vscode-list-activeSelectionForeground);
        }
        
        .table-item-link.active .row-count-badge {
            background: rgba(255, 255, 255, 0.2);
            color: var(--vscode-list-activeSelectionForeground);
        }
        
        .table-item-link .selection-arrow {
            display: none;
        }


        /* --- Main Content Area --- */
        .container {
            flex: 1;
            background: var(--light);
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            min-width: 0;
            min-height: 0;
            animation: fadeIn 0.4s ease-out;
        }
        
        /* Query Panel */
        .query-panel {
            background: var(--vscode-input-background);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 20px;
            transition: var(--transition);
        }
        
        .query-panel.collapsed {
            padding: 10px 15px;
        }
        
        .query-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            user-select: none;
        }
        
        .query-header h3 {
            margin: 0;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--dark);
        }
        
        .query-header h3 i {
            color: var(--primary-color);
        }
        
        .query-content {
            margin-top: 12px;
            display: none;
        }
        
        .query-panel:not(.collapsed) .query-content {
            display: block;
            animation: fadeIn 0.3s ease-out;
        }
        
        .query-input {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--light);
            color: var(--dark);
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 13px;
            resize: vertical;
            transition: var(--transition);
        }
        
        .query-input:focus {
            outline: none;
            border-color: var(--secondary-button-color);
            box-shadow: 0 0 0 2px rgba(127, 92, 255, 0.1);
        }
        
        .query-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }
        
        h1 {
            margin: 0;
            font-weight: 700;
            font-size: 24px;
            color: var(--dark);
        }

        h1.table-name-heading {
            color: var(--primary-color);
        }
        
        .header-actions {
            display: flex;
            gap: 10px;
        }
        
        .action-button {
            padding: 8px 16px;
            background: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .action-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .action-button:not(:disabled):hover {
            background: var(--vscode-button-hoverBackground);
            transform: translateY(-1px);
        }

        .action-button.secondary {
            background: transparent;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }

        .action-button.secondary:not(:disabled):hover {
            background: rgba(0, 120, 212, 0.1);
            color: var(--primary-dark);
        }
        
        /* --- Table View --- */
        .data-panel {
            flex: 1;
            overflow-y: hidden;
            border-radius: 6px;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        #tableContent {
            flex: 1;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .table-wrapper {
            overflow: auto;
            flex: 1;
            min-height: 0;
        }

        .table-info-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding: 12px;
            background: var(--vscode-input-background);
            border-radius: 6px;
            flex-wrap: wrap;
            gap: 10px;
            flex-shrink: 0;
        }
        
        .table-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .filter-input {
            padding: 6px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            background: var(--light);
            color: var(--dark);
            font-size: 13px;
            min-width: 200px;
            transition: var(--transition);
        }
        
        .filter-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 120, 212, 0.1);
        }

        .table-stats {
            color: var(--gray);
            font-size: 12px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        /* Pagination */
        .pagination {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 15px;
            justify-content: center;
            padding: 15px;
            background: var(--vscode-input-background);
            border-radius: var(--border-radius-sm);
        }
        
        .pagination button {
            padding: 6px 12px;
            background: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-size: 12px;
            transition: var(--transition);
        }
        
        .pagination button:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .pagination button:not(:disabled):hover {
            background: var(--vscode-button-hoverBackground);
        }
        
        .pagination .page-info {
            color: var(--dark);
            font-size: 13px;
            font-weight: 500;
            padding: 0 10px;
        }
        
        .pagination select {
            padding: 6px 10px;
            background: var(--light);
            color: var(--dark);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            font-size: 12px;
            cursor: pointer;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            overflow: hidden;
            border-radius: 8px; 
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            min-width: 800px;
        }
        
        th, td {
            padding: 12px 16px; 
            text-align: left;
            white-space: nowrap;
            min-width: 100px;
            max-width: 400px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        th {
            background: var(--table-header-bg);
            color: white; 
            font-weight: 600;
            text-transform: uppercase;
            font-size: 12px;
            border-bottom: none; 
            position: sticky;
            top: 0;
            z-index: 5;
            cursor: pointer;
            user-select: none;
            transition: var(--transition);
        }
        
        th:hover {
            background: var(--primary-dark);
        }
        
        th .sort-indicator {
            margin-left: 6px;
            font-size: 10px;
            opacity: 0.6;
        }
        
        th.sorted .sort-indicator {
            opacity: 1;
        }
        
        /* Zebra Striping */
        tr:nth-child(even) {
            background-color: var(--table-row-even);
        }

        tr:nth-child(odd) {
            background-color: var(--light);
        }
        
        tr:hover {
            background-color: var(--table-row-hover) !important;
        }

        td {
            border-bottom: 1px solid var(--border-color);
            font-size: 13px;
            cursor: pointer;
            /* removed transition to prevent hover trail effect */
            position: relative;
        }
        
        td:hover {
            background-color: var(--vscode-list-hoverBackground) !important;
        }

        td::after {
            content: '\f0c5'; /* Copy Icon */
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%) scale(0.8);
            font-size: 14px;
            color: var(--primary-color);
            background: var(--vscode-editor-background);
            padding: 5px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            opacity: 0;
            pointer-events: none;
            transition: all 0.2s cubic-bezier(0.18, 0.89, 0.32, 1.28);
            z-index: 10;
        }
        
        td:hover::after {
            opacity: 1;
            transform: translateY(-50%) scale(1);
            transition-delay: 0.05s;
        }
        
        tr:last-child td {
            border-bottom: none; 
        }

        /* Highlight NULL values */
        td[data-value="NULL"] { 
            color: var(--vscode-editorUnnecessary-foreground); 
            font-style: italic; 
        }

        /* Data Type Color Coding */
        td[data-type="number"] {
            color: #0e7490;
            font-weight: 500;
        }
        
        td[data-type="string"] {
            color: var(--vscode-editor-foreground);
        }
        
        td[data-type="object"]:not([data-value="NULL"]) {
            color: #7c3aed;
            font-style: italic;
        }
        
        td[data-type="boolean"] {
            color: #dc2626;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        /* Cell Preview Modal */
        .cell-preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.2s ease-out;
        }
        
        .cell-preview-content {
            background: var(--light);
            padding: 25px;
            border-radius: 8px;
            box-shadow: var(--shadow-hover);
            max-width: 80%;
            max-height: 80%;
            overflow: auto;
            animation: fadeIn 0.3s ease-out;
        }
        
        .cell-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .cell-preview-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }
        
        .cell-preview-body {
            font-family: 'Consolas', 'Courier New', monospace;
            white-space: pre-wrap;
            word-break: break-all;
            color: var(--dark);
            font-size: 13px;
            line-height: 1.6;
        }

        .cell-edit-input {
            width: 100%;
            height: 100%;
            border: none;
            outline: 2px solid var(--primary-color);
            background: var(--vscode-input-background);
            color: var(--vscode-input-foreground);
            font-family: inherit;
            font-size: 13px;
            padding: 12px 16px; /* Match td padding */
            margin: 0;
            box-sizing: border-box;
            display: block;
            border-radius: 0;
        }
        
        td.editing {
            padding: 0 !important;
        }
        
        .placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--gray);
            font-size: 14px;
            text-align: center;
            padding: 40px;
        }
        
        .placeholder i {
            color: var(--gray);
            opacity: 0.5;
        }

        .error {
            padding: 10px 15px;
            background: var(--vscode-inputValidation-errorBackground);
            border: 1px solid var(--vscode-inputValidation-errorBorder);
            border-radius: var(--border-radius-sm);
            color: var(--vscode-errorForeground);
            margin-bottom: 15px;
        }

        /* --- Modal (Schema View) --- */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
            animation: fadeIn 0.3s ease-out;
        }

        .modal-content {
            background-color: var(--light);
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-hover);
            border: 1px solid var(--border-color);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            animation: bounceIn 0.3s ease-out;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .modal-header h2 {
            font-size: 18px;
            font-weight: 600;
            color: var(--dark);
        }

        .close-button {
            background: none;
            border: none;
            color: var(--dark);
            font-size: 24px;
            cursor: pointer;
            padding: 0 5px;
            line-height: 1;
        }
        
        .close-button:hover {
            color: var(--vscode-errorForeground);
        }

        .schema-table {
            width: 100%;
            border-collapse: collapse;
        }

        .schema-table th, .schema-table td {
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            text-align: left;
            font-size: 13px;
        }
        .schema-table th {
            background-color: var(--vscode-sideBarSectionHeader-background);
            font-weight: 600;
            text-transform: uppercase;
        }

        /* --- Chart View --- */
        .chart-panel {
            flex: 1;
            /* Same styling as data-panel effectively */
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 0;
            animation: fadeIn 0.4s ease-out;
            background: var(--light);
        }

        .chart-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px;
            background: var(--vscode-input-background);
            border-radius: 6px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            border: 1px solid var(--border-color);
        }

        .chart-control-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chart-control-group label {
            font-size: 12px;
            font-weight: 600;
            color: var(--dark);
        }

        .chart-select {
            padding: 6px 10px;
            background: var(--light);
            color: var(--dark);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-sm);
            font-size: 12px;
            min-width: 120px;
        }

        .chart-canvas-container {
            flex: 1;
            position: relative;
            min-height: 0;
            padding: 10px;
            display: flex; /* Center the chart */
            justify-content: center;
            align-items: center;
        }

        /* Ensure chart doesn't overflow */
        .chart-canvas-container canvas {
            max-width: 100%;
            max-height: 100%;
        }

        .chart-warning {
            padding: 10px;
            color: var(--warning-color);
            background: rgba(255, 140, 0, 0.1);
            border: 1px solid rgba(255, 140, 0, 0.3);
            border-radius: 4px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
    </style>
</head>

<body>
    <div class="layout">
        <div class="sidebar">
            <div class="sidebar-header">
                <i class="fas fa-database"></i>
                <h3>Tables</h3>
            </div>
            <div class="search-box">
                <input type="text" id="tableSearch" placeholder="Search tables..." oninput="filterTables()">
            </div>
            <ul id="tableList">
                <li><a class="table-item-link"><i class="fas fa-spinner fa-spin"></i> Loading tables...</a></li>
            </ul>
        </div>

        <div class="container">
            <div class="header">
                <h1 id="mainHeading">Database Viewer</h1>
                <div class="header-actions">
                    <button id="refreshButton" class="action-button secondary" style="display:none;" onclick="refreshTable()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                    <button id="viewSchemaButton" class="action-button secondary" style="display:none;" onclick="openSchemaModal()">
                        <i class="fas fa-info-circle"></i> Schema
                    </button>
                    <button id="exportCsvButton" class="action-button secondary" style="display:none;" onclick="exportToCSV()">
                        <i class="fas fa-file-csv"></i> Export CSV
                    </button>
                    <button id="exportJsonButton" class="action-button secondary" style="display:none;" onclick="exportToJSON()">
                        <i class="fas fa-file-code"></i> Export JSON
                    </button>
                    <button id="copyAllButton" class="action-button secondary" style="display:none;" onclick="copyAllData()">
                        <i class="fas fa-copy"></i> Copy All
                    </button>
                    <button id="chartToggleButton" class="action-button secondary" style="display:none;" onclick="toggleChartView()">
                        <i class="fas fa-chart-bar"></i> Chart
                    </button>
                </div>
            </div>

            <!-- SQL Query Panel -->
            <div class="query-panel collapsed" id="queryPanel">
                <div class="query-header" onclick="toggleQueryPanel()">
                    <h3><i class="fas fa-terminal"></i> SQL Query Editor <span id="queryToggleIcon" style="font-size: 12px;">(click to expand)</span></h3>
                    <i class="fas fa-chevron-down" id="queryChevron"></i>
                </div>
                <div class="query-content">
                    <textarea class="query-input" id="queryInput" placeholder="Enter your SQL query here... (e.g., SELECT * FROM tablename WHERE condition)"></textarea>
                    <div class="query-actions">
                        <button class="action-button" onclick="executeQuery()">
                            <i class="fas fa-play"></i> Execute Query
                        </button>
                        <button class="action-button secondary" onclick="clearQuery()">
                            <i class="fas fa-eraser"></i> Clear
                        </button>
                    </div>
                </div>
            </div>

            <div id="errorContainer"></div>

            <div class="data-panel" id="tableContent">
                <div class="placeholder">
                    <p><i class="fas fa-hand-pointer" style="font-size: 48px; opacity: 0.3; margin-bottom: 15px;"></i>
                        <br>Select a table from the sidebar to view its contents.</p>
                </div>
            </div>

            <div class="pagination" id="pagination" style="display:none;">
                <button onclick="goToFirstPage()"><i class="fas fa-angle-double-left"></i></button>
                <button onclick="previousPage()"><i class="fas fa-angle-left"></i> Previous</button>
                <span class="page-info" id="pageInfo">Page 1 of 1</span>
                <button onclick="nextPage()">Next <i class="fas fa-angle-right"></i></button>
                <button onclick="goToLastPage()"><i class="fas fa-angle-double-right"></i></button>
                <select id="pageSizeSelect" onchange="changePageSize()">
                    <option value="50">50 rows</option>
                    <option value="100" selected>100 rows</option>
                    <option value="200">200 rows</option>
                    <option value="500">500 rows</option>
                </select>
            </div>

            <!-- Chart Panel -->
            <div class="chart-panel" id="chartPanel" style="display:none;">
                <div class="chart-controls">
                    <div class="chart-control-group">
                        <label>Type:</label>
                        <select id="chartType" class="chart-select" onchange="ChartManager.updateChart()">
                            <option value="bar">Bar</option>
                            <option value="line">Line</option>
                            <option value="pie">Pie</option>
                            <option value="doughnut">Doughnut</option>
                            <option value="scatter">Scatter</option>
                        </select>
                    </div>
                    <div class="chart-control-group">
                        <label>X Axis (Label):</label>
                        <select id="chartXAxis" class="chart-select" onchange="ChartManager.updateChart()"></select>
                    </div>
                    <div class="chart-control-group">
                        <label>Y Axis (Value):</label>
                        <select id="chartYAxis" class="chart-select" onchange="ChartManager.updateChart()"></select>
                    </div>
                     <div class="chart-control-group">
                        <label>Mode:</label>
                         <select id="chartMode" class="chart-select" onchange="ChartManager.updateChart()">
                            <option value="raw">Raw Data</option>
                            <option value="aggregate">Aggregate (Sum)</option>
                         </select>
                    </div>
                    <div class="chart-control-group">
                        <label>Limit:</label>
                        <select id="chartLimit" class="chart-select" onchange="ChartManager.changeLimit()">
                            <option value="50">50</option>
                            <option value="100">100</option>
                            <option value="200">200</option>
                            <option value="500">500</option>
                            <option value="1000">1000</option>
                        </select>
                    </div>
                    <div class="chart-control-group">
                        <label>Color:</label>
                        <select id="chartTheme" class="chart-select" onchange="ChartManager.updateChart()">
                            <option value="default">Default (Blue)</option>
                            <option value="fun">Static RGB</option>
                            <option value="ocean">Ocean</option>
                            <option value="warm">Warm</option>
                            <option value="vscode">VS Code</option>
                        </select>
                    </div>
                    <button class="action-button secondary" onclick="ChartManager.saveImage()" title="Save Chart as Image">
                        <i class="fas fa-camera"></i>
                    </button>
                    <div id="chartWarning" class="chart-warning" style="display:none;">
                         <i class="fas fa-exclamation-triangle"></i> showing top 50 rows
                    </div>
                </div>
                <div class="chart-canvas-container">
                    <canvas id="dataChart"></canvas>
                    <div id="chartPlaceholder" class="placeholder" style="display:none;">
                        <i class="fas fa-chart-line" style="font-size: 48px; margin-bottom: 15px;"></i>
                        <p>No suitable numeric data found to visualize.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="schemaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTableName">Table Schema</h2>
                <button class="close-button" onclick="closeSchemaModal()">&times;</button>
            </div>
            <div id="schemaTableContainer"></div>
        </div>
    </div>

    <div id="cellPreviewModal" class="cell-preview-modal" onclick="closeCellPreview(event)">
        <div class="cell-preview-content" onclick="event.stopPropagation()">
            <div class="cell-preview-header">
                <h3 id="cellPreviewTitle">Cell Content</h3>
                <button class="close-button" onclick="closeCellPreview()">&times;</button>
            </div>
            <div class="cell-preview-body" id="cellPreviewBody"></div>
        </div>
    </div>

    <script>
        const vscode = acquireVsCodeApi();
        let currentTable = null;
        let currentSchema = [];
        let currentData = [];
        let filteredData = [];
        let allTables = [];
        let currentPage = 1;
        let pageSize = 100;
        let totalPages = 1;
        let totalRows = 0;
        let sortColumn = null;
        let sortDirection = 'asc';
        let currentSearchTerm = '';
        let isQueryView = false;
        let searchDebounceTimeout = null;
        const mainHeading = document.getElementById('mainHeading');

        // --- Chart Themes ---
        const ChartThemes = {
            default: {
                colors: ['#0078d4'], // Single sophisticated blue
                border: null
            },
            fun: {
                colors: ['#ff00ff', '#00ffff', '#ffff00', '#ff0000', '#00ff00', '#0000ff'], // Static RGB fun
                border: '#ffffff'
            },
            ocean: {
                colors: ['#0077be', '#0088cc', '#0099db', '#00aaeb', '#00bbfa'], // Sophisticated Ocean
                border: null
            },
            warm: {
                colors: ['#e74c3c', '#e67e22', '#f1c40f', '#d35400', '#c0392b'], // Sophisticated Warm
                border: null
            },
            vscode: {
                colors: [
                    '#0078d4', '#00bcf2', '#107c10', '#5c2d91', '#b4009e', 
                    '#e81123', '#d83b01', '#00188f', '#008272', '#a80000'
                ],
                border: null
            }
        };

        // --- Chart Manager ---
        const ChartManager = {
            chart: null,
            isActive: false,
            savedTablePageSize: 100,
            
            init() {
                // Initial setup if needed
            },

            toggle() {
                this.isActive = !this.isActive;
                const chartPanel = document.getElementById('chartPanel');
                const tableContent = document.getElementById('tableContent');
                const pagination = document.getElementById('pagination');
                const btn = document.getElementById('chartToggleButton');
                
                if (this.isActive) {
                    // Switch TO Chart Mode
                    this.savedTablePageSize = pageSize; // Save user's table preference
                    
                    // Set data fetch size to match the Chart Limit selector
                    const limitVal = parseInt(document.getElementById('chartLimit').value) || 50;
                    pageSize = limitVal;
                    
                    chartPanel.style.display = 'flex';
                    tableContent.style.display = 'none';
                    pagination.style.display = 'none';
                    btn.classList.add('active'); 
                    btn.innerHTML = '<i class="fas fa-table"></i> Table';
                    
                    // Fetch new data chunk matching the limit
                    // The chart will update automatically via displayTableData -> updateData
                    loadCurrentTable(); 
                } else {
                    // Switch BACK to Table Mode
                    pageSize = this.savedTablePageSize; // Restore user's table preference
                    
                    chartPanel.style.display = 'none';
                    tableContent.style.display = 'flex';
                    
                    // Restore pagination visibility logic
                    if (totalPages > 1) {
                        pagination.style.display = 'flex';
                    } else {
                         pagination.style.display = 'none';
                    }
                    
                    btn.classList.remove('active');
                    btn.innerHTML = '<i class="fas fa-chart-bar"></i> Chart';
                    
                    // Fetch data again with original page size
                    loadCurrentTable();
                }
            },

            changeLimit() {
                if (!this.isActive) return;
                const limitVal = parseInt(document.getElementById('chartLimit').value) || 50;
                pageSize = limitVal;
                // Reload data from extension to get the full N rows
                loadCurrentTable();
            },
            
            updateData() {
                if (!this.isActive) return;
                
                // Use filteredData so charts reflect current search
                const data = filteredData; 
                if (!data || data.length === 0) {
                     this.showPlaceholder('No data available to chart.');
                     return;
                }

                // Identify columns
                const columns = Object.keys(data[0]);
                const numericCols = [];
                const stringCols = [];

                // Analyze first 10 rows to guess type
                columns.forEach(col => {
                    let isNum = true;
                    let hasValue = false;
                    for(let i=0; i<Math.min(data.length, 10); i++) {
                        const val = data[i][col];
                        if (val !== null && val !== undefined && val !== '') {
                            hasValue = true;
                            if (typeof val !== 'number' && isNaN(Number(val))) {
                                isNum = false;
                                break;
                            }
                        }
                    }
                    // If all checked values are numbers (or column is empty but we default to string usually, 
                    // but here strict numeric check)
                    if (hasValue && isNum) numericCols.push(col);
                    else stringCols.push(col);
                });

                // Fail-safe if no string cols, allow numeric as X
                const xOptions = stringCols.length > 0 ? stringCols : columns;
                // If no numeric, we can't chart (unless count, but let's stick to values)
                if (numericCols.length === 0) {
                    this.showPlaceholder('No numeric columns found to visualize.');
                    return;
                }

                // Populate Selectors
                this.populateSelect('chartXAxis', xOptions, xOptions[0]);
                this.populateSelect('chartYAxis', numericCols, numericCols[0]);
                
                this.hidePlaceholder();
                this.updateChart();
            },

            populateSelect(id, options, selected) {
                const select = document.getElementById(id);
                const currentVal = select.value;
                const available = new Set(options);
                
                // If current selection is still valid, keep it. Else use 'selected' hint.
                let nextVal = available.has(currentVal) ? currentVal : selected;
                
                select.innerHTML = '';
                options.forEach(opt => {
                    const optEl = document.createElement('option');
                    optEl.value = opt;
                    optEl.textContent = opt;
                    if (opt === nextVal) optEl.selected = true;
                    select.appendChild(optEl);
                });
                
                select.value = nextVal;
            },

            updateChart() {
                if (!this.isActive) return;

                const xAxisCol = document.getElementById('chartXAxis').value;
                const yAxisCol = document.getElementById('chartYAxis').value;
                const type = document.getElementById('chartType').value;
                const mode = document.getElementById('chartMode').value;
                const limitVal = parseInt(document.getElementById('chartLimit').value) || 50;
                const themeName = document.getElementById('chartTheme').value || 'default';
                
                let data = filteredData;
                
                if (!xAxisCol || !yAxisCol) return;

                const MAX_POINTS = limitVal;
                let chartLabels = [];
                let chartValues = [];
                let warningMsg = '';
                
                if (mode === 'aggregate') {
                    // Group by X and Sum Y
                    const map = new Map();
                    // Limit source data processing for speed? No, 10k is fast in JS.
                    data.forEach(row => {
                        const xVal = row[xAxisCol] === null ? 'NULL' : String(row[xAxisCol]);
                        const yVal = Number(row[yAxisCol]) || 0;
                        map.set(xVal, (map.get(xVal) || 0) + yVal);
                    });
                    
                    // Sort descending by value to show most significant
                    const sorted = Array.from(map.entries()).sort((a, b) => b[1] - a[1]);
                    
                    const displayData = sorted.slice(0, MAX_POINTS);
                    chartLabels = displayData.map(d => d[0]);
                    chartValues = displayData.map(d => d[1]);
                    
                    if (sorted.length > MAX_POINTS) {
                        warningMsg = `Top ${MAX_POINTS} categories by sum`;
                    }
                } else {
                    // Raw Mode
                    if (data.length > MAX_POINTS) {
                        warningMsg = `First ${MAX_POINTS} rows shown (of ${data.length})`;
                    }
                    
                    const slice = data.slice(0, MAX_POINTS);
                    chartLabels = slice.map(d => d[xAxisCol] === null ? '' : String(d[xAxisCol]));
                    chartValues = slice.map(d => Number(d[yAxisCol]) || 0);
                }
                
                this.toggleWarning(!!warningMsg, warningMsg);
                this.render(type, chartLabels, chartValues, xAxisCol, yAxisCol, themeName);
            },

            render(type, labels, data, xLabel, yLabel, themeName) {
                 const ctx = document.getElementById('dataChart').getContext('2d');
                 
                 // Destroy previous instance
                 if (this.chart) {
                     this.chart.destroy();
                 }

                 if (typeof Chart === 'undefined') {
                     this.showPlaceholder('Could not load Chart.js library. Please check your internet connection.');
                     return;
                 }

                 // Theme Logic
                 const theme = ChartThemes[themeName] || ChartThemes.default;
                 
                 const getColors = (count) => {
                    const bgColors = [];
                    const borderColors = [];
                    for(let i=0; i<count; i++) {
                        const col = theme.colors[i % theme.colors.length];
                        bgColors.push(col);
                        // If specific border color defined in theme, use it. Otherwise darken logic or same color.
                        if (theme.border) {
                            borderColors.push(theme.border);
                        } else {
                            // Simple logic: if transparent desired, maybe modify here. 
                            // But usually chartjs likes matching borders or slightly darker.
                            // For simplicity, re-use color or assume solid.
                            borderColors.push(col);
                        }
                    }
                    return { bg: bgColors, border: borderColors };
                 };

                 const { bg: colors, border: borderColors } = getColors(labels.length);

                 const isLine = type === 'line' || type === 'scatter';
                 
                 // Specific line chart styling override to single color usually, or allow multi-colored segments?
                 // Standard chart.js line charts usually use one color for the whole line.
                 // We will pick the first color of the theme for the line.
                 const lineMainColor = theme.colors[0];

                 const config = {
                     type: type,
                     data: {
                         labels: labels,
                         datasets: [{
                             label: yLabel,
                             data: data,
                             backgroundColor: isLine ? `${lineMainColor}33` : colors, // 33 for ~20% opacity hex
                             borderColor: isLine ? lineMainColor : borderColors,
                             borderWidth: 1,
                             fill: isLine,
                             pointBackgroundColor: isLine ? colors : undefined 
                         }]
                     },
                     options: {
                         responsive: true,
                         maintainAspectRatio: false,
                         animation: {
                             duration: 400
                         },
                         plugins: {
                             title: {
                                display: true,
                                text: `${yLabel} by ${xLabel}`,
                                color: getComputedStyle(document.body).getPropertyValue('--vscode-foreground')
                             },
                             legend: {
                                 display: type === 'pie' || type === 'doughnut',
                                 labels: {
                                     color: getComputedStyle(document.body).getPropertyValue('--vscode-foreground')
                                 }
                             }
                         },
                         scales: (type === 'pie' || type === 'doughnut') ? {} : {
                             x: {
                                 ticks: { color: getComputedStyle(document.body).getPropertyValue('--vscode-descriptionForeground') },
                                 grid: { color: getComputedStyle(document.body).getPropertyValue('--vscode-panel-border') }
                             },
                             y: {
                                 beginAtZero: true,
                                 ticks: { color: getComputedStyle(document.body).getPropertyValue('--vscode-descriptionForeground') },
                                 grid: { color: getComputedStyle(document.body).getPropertyValue('--vscode-panel-border') }
                             }
                         }
                     }
                 };
                 
                 this.chart = new Chart(ctx, config);
            },
            
            showPlaceholder(msg) {
                if (this.chart) {
                    this.chart.destroy();
                    this.chart = null;
                }
                document.getElementById('dataChart').style.display = 'none';
                const ph = document.getElementById('chartPlaceholder');
                ph.style.display = 'flex';
                ph.querySelector('p').textContent = msg;
                // Don't hide controls entirely, just the chart, so user can maybe pick diff columns? 
                // But if no numeric cols, controls useless.
                if(msg.includes('No numeric')) {
                    document.querySelector('.chart-controls').style.display = 'none';
                }
            },

            hidePlaceholder() {
                document.getElementById('dataChart').style.display = 'block';
                document.getElementById('chartPlaceholder').style.display = 'none';
                document.querySelector('.chart-controls').style.display = 'flex';
            },
            
            toggleWarning(show, msg) {
                const w = document.getElementById('chartWarning');
                w.style.display = show ? 'flex' : 'none';
                if(msg) w.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${msg}`;
            },

            saveImage() {
                if (!this.chart) return;
                const link = document.createElement('a');
                link.download = `chart_${new Date().toISOString().slice(0,19).replace(/:/g,'-')}.png`;
                link.href = this.chart.toBase64Image();
                link.click();
            }
        };

        function toggleChartView() {
            ChartManager.toggle();
        }

        // --- Message Handling from Extension ---
        window.addEventListener('message', event => {
            const message = event.data;
            
            switch (message.type) {
                case 'databaseLoaded':
                    allTables = message.tables;
                    displayTables(message.tables);
                    break;
                case 'updateRowCount':
                    updateRowCount(message.tableName, message.rowCount);
                    break;
                case 'tableData':
                    currentSchema = message.schema;
                    currentData = message.data;
                    filteredData = [...currentData];
                    currentPage = message.page || 1;
                    pageSize = message.pageSize || 100;
                    totalPages = message.totalPages || 1;
                    totalRows = message.rowCount || 0;
                    displayTableData(message.tableName, message.schema, message.data, message.rowCount);
                    break;
                case 'queryResult':
                    displayQueryResult(message);
                    break;
                case 'error':
                    showError(message.message);
                    break;
                case 'updateSuccess':
                    handleUpdateSuccess(message);
                    break;
                case 'updateError':
                    handleUpdateError(message);
                    break;
            }
        });

        // --- Keyboard Shortcuts ---
        document.addEventListener('keydown', event => {
            // Ctrl+R or F5: Refresh current table
            if ((event.ctrlKey && event.key === 'r') || event.key === 'F5') {
                event.preventDefault();
                refreshTable();
            }
            // Ctrl+F: Focus search input
            else if (event.ctrlKey && event.key === 'f') {
                event.preventDefault();
                const searchInput = document.querySelector('.table-search-input');
                if (searchInput) searchInput.focus();
            }
            // Ctrl+Shift+C: Copy all data
            else if (event.ctrlKey && event.shiftKey && event.key === 'C') {
                event.preventDefault();
                copyAllData();
            }
        });

        // --- Sidebar Functionality ---
        function displayTables(tables) {
            const tableList = document.getElementById('tableList');
            tableList.innerHTML = '';
            
            if (tables.length === 0) {
                tableList.innerHTML = '<li><a class="table-item-link"><i class="fas fa-exclamation-circle table-icon"></i><span class="table-name">No tables found</span></a></li>';
                return;
            }

            tables.forEach(table => {
                const tableName = typeof table === 'string' ? table : table.name;
                const rowCount = typeof table === 'object' ? table.rowCount : undefined;
                
                const li = document.createElement('li');
                const link = document.createElement('a');
                link.className = 'table-item-link';
                link.setAttribute('data-table-name', tableName);
                
                let badgeHtml = '';
                if (rowCount !== undefined && rowCount !== null) {
                    badgeHtml = `<span class="row-count-badge">${formatNumber(rowCount)}</span>`;
                } else {
                    badgeHtml = `<span class="row-count-badge"><i class="fas fa-spinner fa-spin" style="font-size: 0.8em;"></i></span>`;
                }

                link.innerHTML = `
                    <div class="table-item-content">
                        <i class="fas fa-table table-icon"></i>
                        <span class="table-name">${escapeHtml(tableName)}</span>
                    </div>
                    ${badgeHtml}
                `;
                link.onclick = (e) => {
                    e.preventDefault();
                    selectTable(tableName, link);
                };
                li.appendChild(link);
                tableList.appendChild(li);
            });
        }

        function updateRowCount(tableName, count) {
            // Update internal data model
            const tableIndex = allTables.findIndex(t => (typeof t === 'string' ? t : t.name) === tableName);
            if (tableIndex !== -1) {
                if (typeof allTables[tableIndex] === 'string') {
                    allTables[tableIndex] = { name: tableName, rowCount: count };
                } else {
                    allTables[tableIndex].rowCount = count;
                }
            }

            // Update UI
            const links = document.querySelectorAll('.table-item-link');
            for (const link of links) {
                if (link.getAttribute('data-table-name') === tableName) {
                    const badge = link.querySelector('.row-count-badge');
                    if (badge) {
                        badge.textContent = formatNumber(count);
                    }
                    break;
                }
            }
        }
        
        function filterTables() {
            const searchTerm = document.getElementById('tableSearch').value.toLowerCase();
            const filteredTables = allTables.filter(table => {
                const tableName = typeof table === 'string' ? table : table.name;
                return tableName.toLowerCase().includes(searchTerm);
            });
            displayTables(filteredTables);
        }

        function selectTable(tableName, element) {
            document.querySelectorAll('.table-item-link').forEach(item => {
                item.classList.remove('active');
            });
            
            element.classList.add('active');
            
            currentTable = tableName;
            isQueryView = false;
            currentPage = 1;
            sortColumn = null;
            sortDirection = 'asc';
            currentSearchTerm = '';
            
            document.getElementById('viewSchemaButton').style.display = 'none';
            document.getElementById('exportCsvButton').style.display = 'none';
            document.getElementById('exportJsonButton').style.display = 'none';
            document.getElementById('chartToggleButton').style.display = 'none';
            
            mainHeading.textContent = escapeHtml(tableName);
            mainHeading.classList.add('table-name-heading'); 

            vscode.postMessage({
                type: 'getTableData',
                tableName: tableName,
                page: currentPage,
                pageSize: pageSize
            });

            const tableContent = document.getElementById('tableContent');
            tableContent.innerHTML = `
                <div class="placeholder">
                    <i class="fas fa-sync fa-spin" style="margin-right: 10px; font-size: 24px;"></i>
                    <span>Loading data for <strong>${escapeHtml(tableName)}</strong>...</span>
                </div>`;
            document.getElementById('errorContainer').innerHTML = '';
            document.getElementById('pagination').style.display = 'none';
        }

        // --- Table View Functionality ---
        function displayTableData(tableName, schema, data, rowCount) {
            const tableContent = document.getElementById('tableContent');
            document.getElementById('refreshButton').style.display = 'flex';
            document.getElementById('viewSchemaButton').style.display = 'flex';
            document.getElementById('exportCsvButton').style.display = 'flex';
            document.getElementById('exportJsonButton').style.display = 'flex';
            document.getElementById('copyAllButton').style.display = 'flex';
            document.getElementById('chartToggleButton').style.display = 'flex';

            if (ChartManager.isActive) {
                ChartManager.updateData();
            }
            
            if (data.length === 0) {
                let emptyMessage = rowCount > 0 
                    ? 'Table data could not be loaded or is filtered.'
                    : 'The table is empty. No rows found.';
                
                // Check if controls already exist to preserve search input during empty search result
                if (document.querySelector('.table-info-bar')) {
                    // Just update the stats and table body
                    const stats = document.querySelector('.table-stats');
                    if (stats) {
                        stats.innerHTML = `<i class="fas fa-database"></i> ${formatNumber(rowCount)} total rows | ${schema.length} columns`;
                    }
                    const tbody = document.getElementById('tableBody');
                    if (tbody) {
                        tbody.innerHTML = `<tr><td colspan="${schema.length}" style="text-align:center; padding: 20px; color: var(--gray);">No data found matching your search.</td></tr>`;
                    }
                    updatePagination();
                    return;
                }

                tableContent.innerHTML = `<div class="placeholder"><p>${emptyMessage}</p></div>`;
                document.getElementById('pagination').style.display = 'none';
                return;
            }

            const columns = Object.keys(data[0]).filter(k => k !== '__rowid__');

            // Check if table structure already exists to avoid re-rendering controls
            if (document.getElementById('dataTable')) {
                 // Update stats
                const stats = document.querySelector('.table-stats');
                if (stats) {
                    stats.innerHTML = `<i class="fas fa-database"></i> ${formatNumber(rowCount)} total rows | ${schema.length} columns`;
                }

                // Update Header if schema changed (unlikely for same table, but safe)
                const thead = document.querySelector('#dataTable thead tr');
                if (thead && thead.children.length !== columns.length) {
                     thead.innerHTML = columns.map(col => `<th onclick="sortTable('${col}')">${escapeHtml(col)}<span class="sort-indicator"></span></th>`).join('');
                }

                // Update Body
                const tbody = document.getElementById('tableBody');
                if (tbody) {
                    tbody.innerHTML = renderTableRows(data, columns);
                }
            } else {
                const tableGridHtml = `
                    <div class="table-info-bar">
                        <div class="table-controls">
                            <input type="text" class="filter-input" placeholder="Filter rows..." value="${escapeHtml(currentSearchTerm)}" oninput="filterTableData(this.value)">
                        </div>
                        <span class="table-stats">
                            <i class="fas fa-database"></i>
                            ${formatNumber(rowCount)} total rows | ${schema.length} columns
                        </span>
                    </div>
                    <div class="table-wrapper">
                        <table id="dataTable">
                            <thead>
                                <tr>
                                    ${columns.map(col => `<th onclick="sortTable('${col}')">${escapeHtml(col)}<span class="sort-indicator"></span></th>`).join('')}
                                </tr>
                            </thead>
                            <tbody id="tableBody">
                                ${renderTableRows(data, columns)}
                            </tbody>
                        </table>
                    </div>
                `;

                tableContent.innerHTML = tableGridHtml;
            }
            updatePagination();
            updateSortIndicators();
        }
        
        function renderTableRows(data, columns) {
            return data.map(row => `
                <tr data-rowid="${row.__rowid__}">
                    ${columns.map(col => {
                        const rawValue = row[col];
                        const value = formatValue(rawValue);
                        let dataType = 'string';
                        
                        if (rawValue === null || rawValue === undefined) {
                            dataType = 'null';
                        } else if (typeof rawValue === 'number') {
                            dataType = 'number';
                        } else if (typeof rawValue === 'boolean') {
                            dataType = 'boolean';
                        } else if (typeof rawValue === 'object') {
                            dataType = 'object';
                        }
                        
                        // row.__rowid__ is the safe alias we're using
                        const rowId = row.__rowid__;
                        // Avoid making rowid column itself editable (if it appears), or if rowId is missing
                        const isEditable = (col !== 'rowid' && col !== '__rowid__' && rowId !== undefined);
                        
                        return `<td 
                            data-col="${escapeHtml(col)}" 
                            data-rowid="${rowId || ''}"
                            data-type="${dataType}"
                            class="${isEditable ? 'editable-cell' : ''}"
                            onclick="handleCellClick(this, '${escapeHtml(col)}', ${rowId})">${escapeHtml(value)}</td>`;
                    }).join('')}
                </tr>
            `).join('');
        }
        
        function filterTableData(searchTerm) {
            searchTerm = searchTerm.trim();
            currentSearchTerm = searchTerm;
            
            if (searchDebounceTimeout) {
                clearTimeout(searchDebounceTimeout);
            }

            searchDebounceTimeout = setTimeout(() => {
                currentPage = 1; // Reset to page 1 for new search
                loadCurrentTable();
            }, 300);
        }
        
        function sortTable(column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }
            
            if (isQueryView) {
                clientSideSort(column);
                updateSortIndicators();
            } else {
                // Server-side sorting
                loadCurrentTable();
            }
        }

        function clientSideSort(column) {
             filteredData.sort((a, b) => {
                let valA = a[column];
                let valB = b[column];
                
                if (valA === null || valA === undefined) return 1;
                if (valB === null || valB === undefined) return -1;
                
                if (typeof valA === 'number' && typeof valB === 'number') {
                    return sortDirection === 'asc' ? valA - valB : valB - valA;
                }
                
                valA = String(valA).toLowerCase();
                valB = String(valB).toLowerCase();
                
                if (sortDirection === 'asc') {
                    return valA < valB ? -1 : valA > valB ? 1 : 0;
                } else {
                    return valA > valB ? -1 : valA < valB ? 1 : 0;
                }
            });
            
            const columns = Object.keys(currentData[0]).filter(k => k !== '__rowid__');
            const tbody = document.getElementById('tableBody');
            if (tbody) {
                tbody.innerHTML = renderTableRows(filteredData, columns);
            }
        }

        function updateSortIndicators() {
            if (!currentData || currentData.length === 0) return;
            const columns = Object.keys(currentData[0]).filter(k => k !== '__rowid__');
            
            document.querySelectorAll('th').forEach(th => {
                th.classList.remove('sorted');
                const indicator = th.querySelector('.sort-indicator');
                if (indicator) indicator.textContent = '';
            });
            
            if (sortColumn) {
                const colIndex = columns.indexOf(sortColumn);
                const headers = document.querySelectorAll('th');
                if (colIndex >= 0 && headers[colIndex]) {
                    headers[colIndex].classList.add('sorted');
                    const indicator = headers[colIndex].querySelector('.sort-indicator');
                    if (indicator) {
                        indicator.textContent = sortDirection === 'asc' ? ' ' : ' ';
                    }
                }
            }
        }

        // --- Pagination ---
        function updatePagination() {
            const pagination = document.getElementById('pagination');
            const pageInfo = document.getElementById('pageInfo');
            
            if (totalPages <= 1) {
                pagination.style.display = 'none';
                return;
            }
            
            pagination.style.display = 'flex';
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            
            const pageSizeSelect = document.getElementById('pageSizeSelect');
            pageSizeSelect.value = pageSize.toString();
        }
        
        function previousPage() {
            if (currentPage > 1) {
                currentPage--;
                loadCurrentTable();
            }
        }
        
        function nextPage() {
            if (currentPage < totalPages) {
                currentPage++;
                loadCurrentTable();
            }
        }
        
        function goToFirstPage() {
            if (currentPage !== 1) {
                currentPage = 1;
                loadCurrentTable();
            }
        }
        
        function goToLastPage() {
            if (currentPage !== totalPages) {
                currentPage = totalPages;
                loadCurrentTable();
            }
        }
        
        function changePageSize() {
            pageSize = parseInt(document.getElementById('pageSizeSelect').value);
            currentPage = 1;
            loadCurrentTable();
        }
        
        function loadCurrentTable() {
            if (!currentTable) return;
            
            if (currentSearchTerm) {
                vscode.postMessage({
                    type: 'searchTable',
                    tableName: currentTable,
                    searchTerm: currentSearchTerm,
                    page: currentPage,
                    pageSize: pageSize
                });
            } else {
                vscode.postMessage({
                    type: 'getTableData',
                    tableName: currentTable,
                    page: currentPage,
                    pageSize: pageSize,
                    sortCol: sortColumn,
                    sortDir: sortDirection
                });
            }
        }
        
        // --- Query Panel ---
        function toggleQueryPanel() {
            const panel = document.getElementById('queryPanel');
            const chevron = document.getElementById('queryChevron');
            const toggleIcon = document.getElementById('queryToggleIcon');
            
            panel.classList.toggle('collapsed');
            if (panel.classList.contains('collapsed')) {
                chevron.className = 'fas fa-chevron-down';
                toggleIcon.textContent = '(click to expand)';
            } else {
                chevron.className = 'fas fa-chevron-up';
                toggleIcon.textContent = '(click to collapse)';
            }
        }
        
        function executeQuery() {
            const query = document.getElementById('queryInput').value.trim();
            if (!query) {
                showError('Please enter a SQL query.');
                return;
            }
            
            vscode.postMessage({
                type: 'executeQuery',
                query: query
            });
            
            document.getElementById('tableContent').innerHTML = `
                <div class="placeholder">
                    <i class="fas fa-sync fa-spin" style="margin-right: 10px; font-size: 24px;"></i>
                    <span>Executing query...</span>
                </div>`;
        }
        
        function clearQuery() {
            document.getElementById('queryInput').value = '';
        }
        
        function displayQueryResult(message) {
            if (!message.success) {
                showError(`Query execution failed: ${message.error}`);
                return;
            }
            
            isQueryView = true;
            const data = message.data;
            const tableContent = document.getElementById('tableContent');
            
            // Allow charting for query results too
            document.getElementById('chartToggleButton').style.display = 'flex';

            if (!data || data.length === 0) {
                tableContent.innerHTML = '<div class="placeholder"><p>Query executed successfully. No results returned.</p></div>';
                if (ChartManager.isActive) ChartManager.updateData(); // Will show "No data"
                return;
            }
            
            mainHeading.textContent = 'Query Results';
            mainHeading.classList.add('table-name-heading');
            
            currentData = data;
            filteredData = [...data];

            if (ChartManager.isActive) {
                ChartManager.updateData();
            }

            const columns = Object.keys(data[0]);
            
            const tableGridHtml = `
                <div class="table-info-bar">
                    <div class="table-controls">
                        <input type="text" class="filter-input" placeholder="Filter results..." oninput="filterTableData(this.value)">
                    </div>
                    <span class="table-stats">
                        <i class="fas fa-check-circle"></i>
                        ${formatNumber(data.length)} rows returned
                    </span>
                </div>
                <div class="table-wrapper">
                    <table id="dataTable">
                        <thead>
                            <tr>
                                ${columns.map(col => `<th onclick="sortTable('${col}')">${escapeHtml(col)}<span class="sort-indicator"></span></th>`).join('')}
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            ${renderTableRows(data, columns)}
                        </tbody>
                    </table>
                </div>
            `;
            
            tableContent.innerHTML = tableGridHtml;
            document.getElementById('pagination').style.display = 'none';
        }
        
        // --- Export Functions ---
        function exportToCSV() {
            if (!currentData || currentData.length === 0) {
                showNotification('No data to export', 'warning');
                return;
            }
            
            const columns = Object.keys(currentData[0]);
            let csv = columns.map(col => `"${col}"`).join(',') + '\n';
            
            currentData.forEach(row => {
                const values = columns.map(col => {
                    const val = row[col];
                    if (val === null || val === undefined) return '""';
                    return `"${String(val).replace(/"/g, '""')}"`;
                });
                csv += values.join(',') + '\n';
            });
            
            vscode.postMessage({
                type: 'saveFile',
                content: csv,
                filename: `${currentTable || 'query_result'}.csv`,
                fileType: 'csv'
            });
        }
        
        function exportToJSON() {
            if (!currentData || currentData.length === 0) {
                showNotification('No data to export', 'warning');
                return;
            }
            
            const json = JSON.stringify(currentData, null, 2);
            vscode.postMessage({
                type: 'saveFile',
                content: json,
                filename: `${currentTable || 'query_result'}.json`,
                fileType: 'json'
            });
        }
        
        // --- Cell Preview Modal ---
        function showCellPreview(columnName, value) {
            document.getElementById('cellPreviewTitle').textContent = `Column: ${columnName}`;
            document.getElementById('cellPreviewBody').textContent = value === 'NULL' ? '(NULL)' : value;
            document.getElementById('cellPreviewModal').style.display = 'flex';
        }
        
        function closeCellPreview(event) {
            if (!event || event.target.id === 'cellPreviewModal') {
                document.getElementById('cellPreviewModal').style.display = 'none';
            }
        }

        // --- Schema Modal ---
        function openSchemaModal() {
            if (!currentTable || currentSchema.length === 0) {
                showError('Could not load schema data for the selected table.');
                return;
            }
            document.getElementById('modalTableName').textContent = `Schema for: ${currentTable}`;
            const schemaContainer = document.getElementById('schemaTableContainer');
            const schemaHtml = `
                <table class="schema-table">
                    <thead>
                        <tr>
                            <th>CID</th><th>Name</th><th>Type</th><th>Not Null</th><th>Default</th><th>PK</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${currentSchema.map(col => `
                            <tr>
                                <td onclick="copyCellValue(this)" title="Click to copy">${col[0]}</td>
                                <td onclick="copyCellValue(this)" title="Click to copy">${escapeHtml(col[1])}</td>
                                <td onclick="copyCellValue(this)" title="Click to copy">${escapeHtml(col[2])}</td>
                                <td onclick="copyCellValue(this)" title="Click to copy">${col[3] == 1 ? 'YES' : 'NO'}</td>
                                <td onclick="copyCellValue(this)" title="Click to copy">${formatValue(col[4])}</td>
                                <td onclick="copyCellValue(this)" title="Click to copy">${col[5] == 1 ? 'KEY' : ''}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            schemaContainer.innerHTML = schemaHtml;
            document.getElementById('schemaModal').style.display = 'flex';
        }

        function closeSchemaModal() {
            document.getElementById('schemaModal').style.display = 'none';
        }

        // --- Utility Functions ---
        function formatValue(value) {
            if (value === null || value === undefined) { return 'NULL'; }
            if (typeof value === 'object') { 
                try { 
                    if (Array.isArray(value)) return `[Array(${value.length})]`;
                    return JSON.stringify(value); 
                } catch { return '[Object]'; } 
            }
            return String(value);
        }

        function escapeHtml(text) {
            const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#039;' };
            return String(text).replace(/[&<>"']/g, m => map[m]);
        }
        
        function formatNumber(num) {
            return new Intl.NumberFormat().format(num);
        }

        function showError(message) {
            const errorContainer = document.getElementById('errorContainer');
            errorContainer.innerHTML = `<div class="error"><strong> Error:</strong> ${escapeHtml(message)}</div>`;
        }

        // --- New Feature Functions ---
        function refreshTable() {
            if (!currentTable) {
                showNotification('No table selected', 'warning');
                return;
            }
            loadCurrentTable();
            showNotification('Table refreshed successfully', 'success');
        }

        let clickTimeout = null;
        let lastClickedCell = null;

        function handleCellClick(cell, colName, rowId) {
            // Disable copy/click actions while editing
            if (cell.classList.contains('editing') || cell.querySelector('.cell-edit-input')) {
                return;
            }

            // Check for missing rowId explicitly to warn user
            if (rowId === undefined || rowId === null) {
                if (colName !== 'rowid') {
                     // Only warn once per session/view to avoid spam, or use a specific visual indicator
                     // But for now, just copy and maybe log.
                     // Actually, if rowId is missing, double click is impossible.
                     console.warn('Edit mode disabled: Missing rowid. Please reload the extension/table.');
                     
                     // If it's a double-click attempt (heuristic), warn the user
                     if (clickTimeout && lastClickedCell === cell) {
                         clearTimeout(clickTimeout);
                         clickTimeout = null;
                         showNotification('Edit disabled: Reload extension to enable (missing rowid)', 'warning');
                         return;
                     }
                }
                
                // Fallback to copy logic (with delay for consistency, though double click won't work)
                // We reuse the delay logic so single clicks feel the same
            }

            // If col is rowid, copy only
            if (colName === 'rowid') {
                copyCellValue(cell);
                return;
            }

            if (clickTimeout && lastClickedCell === cell) {
                // Double click: Edit
                clearTimeout(clickTimeout);
                clickTimeout = null;
                lastClickedCell = null;
                
                if (rowId !== undefined && rowId !== null) {
                    enterEditMode(cell, rowId, colName);
                } else {
                     showNotification('Edit disabled: Missing rowid', 'warning');
                }
            } else {
                // First click: Copy delayed
                if (clickTimeout) {
                    clearTimeout(clickTimeout);
                    clickTimeout = null;
                }
                
                lastClickedCell = cell;
                clickTimeout = setTimeout(() => {
                    copyCellValue(cell);
                    clickTimeout = null;
                    lastClickedCell = null;
                }, 200); // reduced to 200ms for snappier feel
            }
        }

        function enterEditMode(cell, rowId, colName) {
            if (cell.classList.contains('editing')) return;

            const originalValue = cell.textContent;
            
            // Lock dimensions to prevent layout shift
            const rect = cell.getBoundingClientRect();
            cell.style.width = `${rect.width}px`;
            cell.style.height = `${rect.height}px`;
            
            cell.classList.add('editing');
            
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'cell-edit-input';
            input.value = originalValue === 'NULL' ? '' : originalValue;
            
            // Commit on Blur or Enter
            const commit = () => {
                const newValue = input.value;
                // If value differs from displayed original (handling NULL case implies we might save empty string as empty string, not NULL)
                // If user wants to set NULL, they might need a specific way, but for now empty string is empty string.
                if (newValue !== (originalValue === 'NULL' ? '' : originalValue)) {
                    saveCell(cell, rowId, colName, newValue);
                } else {
                    cancelEdit(cell, originalValue);
                }
            };
            
            input.onblur = commit;
            input.onkeydown = (e) => {
                if (e.key === 'Enter') {
                    input.blur(); // calls commit
                } else if (e.key === 'Escape') {
                    cancelEdit(cell, originalValue);
                    e.stopPropagation();
                }
            };

            cell.innerHTML = '';
            cell.appendChild(input);
            input.focus();
        }

        function cancelEdit(cell, originalValue) {
            cell.classList.remove('editing');
            cell.style.width = '';
            cell.style.height = '';
            cell.textContent = originalValue;
        }

        function saveCell(cell, rowId, colName, newValue) {
            cell.classList.remove('editing');
            cell.style.width = '';
            cell.style.height = '';
            cell.textContent = newValue;
            
            vscode.postMessage({
                type: 'updateCell',
                tableName: currentTable,
                rowId: rowId,
                column: colName,
                value: newValue
            });
        }
        
        function handleUpdateSuccess(message) {
            showNotification('Cell updated successfully', 'success');
            const cell = document.querySelector(`tr[data-rowid="${message.rowId}"] td[data-col="${message.column}"]`);
            if (cell) {
                cell.classList.add('flash-success');
                setTimeout(() => cell.classList.remove('flash-success'), 500);
            }
        }

        function handleUpdateError(message) {
            showNotification(`Update failed: ${message.error}`, 'error');
            // Revert the cell changes by reloading the table is safest
            refreshTable();
        }

        function copyCellValue(element) {
            // Use data-value if available for cleaner copy (e.g. no extra whitespace), otherwise textContent
            // But checking previous implementation, it used textContent or value. 
            // Let's stick to textContent but trim? Or just textContent as it might be what user sees.
            /* 
               Actually, data-value attribute was set in renderTableRows:
               data-value="${value}"
            */
            const value = element.getAttribute('data-value') || element.textContent;
            const dataType = element.getAttribute('data-type');
            
            navigator.clipboard.writeText(value).then(() => {
                showNotification('Copied to clipboard', 'success');
                element.classList.add('flash-success');
                setTimeout(() => element.classList.remove('flash-success'), 500);
            }).catch(err => {
                console.error('Failed to copy:', err);
                showNotification('Failed to copy to clipboard', 'error');
            });
        }

        function copyAllData() {
            if (!currentData || currentData.length === 0) {
                showNotification('No data to copy', 'warning');
                return;
            }

            const columns = Object.keys(currentData[0]);
            let textData = columns.join('\t') + '\n';
            
            currentData.forEach(row => {
                const values = columns.map(col => {
                    const val = row[col];
                    if (val === null || val === undefined) return '';
                    return String(val);
                });
                textData += values.join('\t') + '\n';
            });

            navigator.clipboard.writeText(textData).then(() => {
                showNotification(`Copied ${currentData.length} rows to clipboard`, 'success');
            }).catch(err => {
                console.error('Failed to copy:', err);
                showNotification('Failed to copy to clipboard', 'error');
            });
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification notification-${type} show`;
            
            let icon = 'fa-info-circle';
            if (type === 'success') icon = 'fa-check-circle';
            if (type === 'warning') icon = 'fa-exclamation-triangle';
            if (type === 'error') icon = 'fa-exclamation-circle';
            
            notification.innerHTML = `<i class="fas ${icon}"></i> <span>${escapeHtml(message)}</span>`;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.remove('show');
                notification.classList.add('hide');
                notification.addEventListener('animationend', () => {
                    notification.remove();
                });
            }, 3000);
        }
    </script>
</body>

</html>